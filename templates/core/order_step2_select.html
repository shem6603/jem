{% extends 'base.html' %}
{% load static %}

{% block title %}Select Your Items - J.E.M{% endblock %}

{% block extra_css %}
<style>
    .item-card.selected {
        border-color: #10b981 !important;
        background-color: #f0fdf4 !important;
        box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2);
    }
    .item-card.selected .selected-icon {
        display: flex !important;
    }
    .item-card:not(.selected) {
        opacity: 0.6;
    }
    .star-btn.starred {
        color: #eab308 !important;
    }
    .star-btn.starred svg {
        fill: currentColor;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-b from-orange-50 via-white to-orange-50 py-12">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-black text-gray-900 mb-2">
                Select Your Items
            </h1>
            <p class="text-lg text-gray-600">
                <span class="font-semibold text-orange-600">{{ bundle_type_display }}</span>
                {% if bundle_price %} - ${{ bundle_price|floatformat:0 }} JMD{% endif %}
            </p>
        </div>
        
        <!-- Progress Bar (Clickable Navigation) -->
        <div class="flex items-center justify-center mb-8">
            <div class="flex items-center space-x-4">
                <a href="{% url 'core:bundle_builder' %}" class="flex items-center group cursor-pointer hover:opacity-80 transition">
                    <div class="w-10 h-10 bg-green-500 text-white rounded-full flex items-center justify-center font-bold group-hover:bg-green-600">‚úì</div>
                    <span class="ml-2 text-green-600 group-hover:text-green-700 font-semibold">Bundle</span>
                </a>
                <div class="w-16 h-1 bg-orange-500"></div>
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-orange-500 text-white rounded-full flex items-center justify-center font-bold">2</div>
                    <span class="ml-2 font-semibold text-orange-600">Select Items</span>
                </div>
                <div class="w-16 h-1 bg-gray-300"></div>
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-gray-300 text-gray-500 rounded-full flex items-center justify-center font-bold">3</div>
                    <span class="ml-2 text-gray-500">Details</span>
                </div>
            </div>
        </div>
        
        <!-- Instructions -->
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-8">
            <div class="flex items-start gap-3">
                <span class="text-2xl">üí°</span>
                <div>
                    <p class="text-blue-800 font-semibold mb-1">How it works:</p>
                    <ul class="text-blue-700 text-sm space-y-1">
                        <li>‚Ä¢ <strong>Click</strong> on items you <strong>WANT</strong> to include them in your bundle</li>
                        <li>‚Ä¢ <strong>Star ‚≠ê</strong> up to 2 items in each category to request more of those items</li>
                        <li>‚Ä¢ <strong>Not selecting any items?</strong> <a href="{% url 'core:bundle_builder' %}" class="text-blue-600 underline font-semibold">Go back</a> and choose "Random Selection" for automatic bundle creation</li>
                        {% if is_custom %}
                        <li>‚Ä¢ <strong>Your custom bundle:</strong> 
                            {% if custom_snack_qty > 0 %}{{ custom_snack_qty }} snacks{% endif %}
                            {% if custom_snack_qty > 0 and custom_juice_qty > 0 %} and {% endif %}
                            {% if custom_juice_qty > 0 %}{{ custom_juice_qty }} juices{% endif %}
                        </li>
                        <li>‚Ä¢ The quantities will be distributed among selected items (starred items get more)</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
        
        <form method="post" id="select-form" onsubmit="return true;">
            {% csrf_token %}
            
            {% if show_snacks %}
            <!-- Snacks Section -->
            <div class="mb-10">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                        <span class="mr-2">üçü</span> Snacks
                        {% if is_custom and custom_snack_qty > 0 %}
                        <span class="ml-3 px-3 py-1 bg-purple-100 text-purple-800 text-sm font-semibold rounded-full">{{ custom_snack_qty }} needed</span>
                        {% endif %}
                    </h2>
                    <div class="flex items-center gap-4">
                        <span class="text-sm text-gray-600">Selected: <span id="snack-selected-count" class="font-bold text-green-600">0</span></span>
                        <span class="text-sm text-gray-600">Starred: <span id="snack-star-count" class="font-bold text-yellow-500">0</span>/2</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    {% for snack in snacks %}
                    <div class="item-card bg-white rounded-xl border-2 border-gray-200 overflow-hidden transition-all duration-200 hover:shadow-lg cursor-pointer relative {% if snack.id in selected_snacks %}selected{% endif %}"
                         data-item-id="{{ snack.id }}" data-category="snack">
                        
                        <!-- Selected Icon -->
                        <div class="selected-icon absolute top-2 right-2 w-6 h-6 bg-green-500 rounded-full items-center justify-center text-white hidden">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                        
                        <!-- Image -->
                        <div class="h-24 bg-gradient-to-br from-yellow-100 to-orange-100 flex items-center justify-center">
                            {% if snack.image %}
                            <img src="{{ snack.image.url }}" alt="{{ snack.name }}" class="h-20 w-20 object-cover rounded-lg">
                            {% else %}
                            <span class="text-4xl">üçü</span>
                            {% endif %}
                        </div>
                        
                        <!-- Info -->
                        <div class="p-3">
                            <h3 class="font-semibold text-gray-900 text-sm truncate">{{ snack.name }}</h3>
                            {% if snack.is_spicy %}
                            <span class="text-xs text-red-600">üå∂Ô∏è Spicy</span>
                            {% endif %}
                        </div>
                        
                        <!-- Star Button -->
                        <button type="button" class="star-btn absolute bottom-2 right-2 p-1 text-gray-400 hover:text-yellow-500 transition {% if snack.id in starred_snacks %}starred{% endif %}"
                                onclick="event.stopPropagation(); toggleStar(this, {{ snack.id }}, 'snack')">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                            </svg>
                        </button>
                        
                        <!-- Hidden Inputs -->
                        <input type="checkbox" name="selected_snacks" value="{{ snack.id }}" class="hidden select-checkbox" {% if snack.id in selected_snacks %}checked{% endif %}>
                        <input type="checkbox" name="starred_snacks" value="{{ snack.id }}" class="hidden star-checkbox" {% if snack.id in starred_snacks %}checked{% endif %}>
                    </div>
                    {% empty %}
                    <p class="col-span-full text-center text-gray-500 py-8">No snacks available</p>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            {% if show_juices %}
            <!-- Juices Section -->
            <div class="mb-10">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                        <span class="mr-2">üßÉ</span> Juices
                        {% if is_custom and custom_juice_qty > 0 %}
                        <span class="ml-3 px-3 py-1 bg-purple-100 text-purple-800 text-sm font-semibold rounded-full">{{ custom_juice_qty }} needed</span>
                        {% endif %}
                    </h2>
                    <div class="flex items-center gap-4">
                        <span class="text-sm text-gray-600">Selected: <span id="juice-selected-count" class="font-bold text-green-600">0</span></span>
                        <span class="text-sm text-gray-600">Starred: <span id="juice-star-count" class="font-bold text-yellow-500">0</span>/2</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    {% for juice in juices %}
                    <div class="item-card bg-white rounded-xl border-2 border-gray-200 overflow-hidden transition-all duration-200 hover:shadow-lg cursor-pointer relative {% if juice.id in selected_juices %}selected{% endif %}"
                         data-item-id="{{ juice.id }}" data-category="juice">
                        
                        <!-- Selected Icon -->
                        <div class="selected-icon absolute top-2 right-2 w-6 h-6 bg-green-500 rounded-full items-center justify-center text-white hidden">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                        
                        <!-- Image -->
                        <div class="h-24 bg-gradient-to-br from-green-100 to-teal-100 flex items-center justify-center">
                            {% if juice.image %}
                            <img src="{{ juice.image.url }}" alt="{{ juice.name }}" class="h-20 w-20 object-cover rounded-lg">
                            {% else %}
                            <span class="text-4xl">üßÉ</span>
                            {% endif %}
                        </div>
                        
                        <!-- Info -->
                        <div class="p-3">
                            <h3 class="font-semibold text-gray-900 text-sm truncate">{{ juice.name }}</h3>
                        </div>
                        
                        <!-- Star Button -->
                        <button type="button" class="star-btn absolute bottom-2 right-2 p-1 text-gray-400 hover:text-yellow-500 transition {% if juice.id in starred_juices %}starred{% endif %}"
                                onclick="event.stopPropagation(); toggleStar(this, {{ juice.id }}, 'juice')">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                            </svg>
                        </button>
                        
                        <!-- Hidden Inputs -->
                        <input type="checkbox" name="selected_juices" value="{{ juice.id }}" class="hidden select-checkbox" {% if juice.id in selected_juices %}checked{% endif %}>
                        <input type="checkbox" name="starred_juices" value="{{ juice.id }}" class="hidden star-checkbox" {% if juice.id in starred_juices %}checked{% endif %}>
                    </div>
                    {% empty %}
                    <p class="col-span-full text-center text-gray-500 py-8">No juices available</p>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Summary & Submit -->
            <div class="bg-white rounded-2xl shadow-lg p-6 sticky bottom-4">
                <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                    <div class="flex items-center gap-6">
                        <div class="text-center">
                            <div class="text-2xl font-black text-green-600" id="total-selected">0</div>
                            <div class="text-xs text-gray-500">Items Selected</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-black text-yellow-500" id="total-starred">0</div>
                            <div class="text-xs text-gray-500">Starred</div>
                        </div>
                    </div>
                    
                    <div class="flex gap-4">
                        <a href="{% url 'core:bundle_builder' %}" class="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-full hover:bg-gray-50 transition">
                            Back
                        </a>
                        <button type="submit" form="select-form" class="px-8 py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            Continue
                            <svg class="inline-block ml-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </form>
        
        <!-- Suggestion Section (Outside main form to prevent conflicts) -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 mt-6">
            <button type="button" onclick="toggleSuggestionForm()" class="w-full flex items-center justify-between text-left">
                <div class="flex items-center">
                    <span class="text-2xl mr-3">üí°</span>
                    <div>
                        <h3 class="font-bold text-gray-900">Can't find what you're looking for?</h3>
                        <p class="text-sm text-gray-600">Suggest new items or provide feedback</p>
                    </div>
                </div>
                <svg id="suggestion-arrow" class="w-6 h-6 text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>
            
            <div id="suggestion-form" class="hidden mt-4 pt-4 border-t border-gray-200">
                <form id="suggestion-submit-form" class="space-y-4">
                    {% csrf_token %}
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Suggestion Type <span class="text-red-500">*</span>
                        </label>
                        <select id="suggestion-type" name="suggestion_type" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                                onchange="toggleItemNameField()">
                            <option value="">Select type...</option>
                            <option value="new_item">New Item Request</option>
                            <option value="feedback">General Feedback</option>
                        </select>
                    </div>
                    
                    <div id="item-name-field" class="hidden">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Item Name <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="item-name" name="item_name" maxlength="200"
                               placeholder="e.g., Oreos, Doritos, etc."
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Message <span class="text-red-500">*</span>
                        </label>
                        <textarea id="suggestion-message" name="message" rows="4" required
                                  placeholder="Tell us what you'd like to see or any feedback you have..."
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Your Name <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="suggestion-name" name="customer_name" maxlength="200" required
                               placeholder="Your name"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Phone (Optional)
                        </label>
                        <input type="text" id="suggestion-phone" name="customer_phone" maxlength="20"
                               placeholder="Your phone number"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                    </div>
                    
                    <div id="suggestion-message-div" class="hidden"></div>
                    
                    <button type="submit" class="w-full px-6 py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-300">
                        Submit Suggestion
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle item card clicks (inclusion model)
    document.querySelectorAll('.item-card').forEach(card => {
        card.addEventListener('click', function() {
            const selectCheckbox = this.querySelector('.select-checkbox');
            selectCheckbox.checked = !selectCheckbox.checked;
            this.classList.toggle('selected', selectCheckbox.checked);
            
            // Show/hide selected icon
            const selectedIcon = this.querySelector('.selected-icon');
            if (selectCheckbox.checked) {
                selectedIcon.style.display = 'flex';
            } else {
                selectedIcon.style.display = 'none';
                // Also unstar if deselected
                const starCheckbox = this.querySelector('.star-checkbox');
                const starBtn = this.querySelector('.star-btn');
                starCheckbox.checked = false;
                starBtn.classList.remove('starred');
            }
            
            updateCounts();
        });
    });
    
    // Initialize counts and visual state
    document.querySelectorAll('.item-card').forEach(card => {
        const selectCheckbox = card.querySelector('.select-checkbox');
        const selectedIcon = card.querySelector('.selected-icon');
        if (selectCheckbox.checked) {
            selectedIcon.style.display = 'flex';
        }
    });
    
    updateCounts();
});

function toggleStar(btn, itemId, category) {
    const card = btn.closest('.item-card');
    const selectCheckbox = card.querySelector('.select-checkbox');
    const starCheckbox = card.querySelector('.star-checkbox');
    
    // Cannot star unselected items
    if (!selectCheckbox.checked) {
        alert('You must select an item first before starring it.');
        return;
    }
    
    // Check star limit (max 2 per category)
    const maxStars = 2;
    const currentStarred = document.querySelectorAll(`[data-category="${category}"] .star-checkbox:checked`).length;
    
    if (!starCheckbox.checked && currentStarred >= maxStars) {
        alert(`You can only star up to ${maxStars} ${category}s. Please unstar another item first.`);
        return;
    }
    
    starCheckbox.checked = !starCheckbox.checked;
    btn.classList.toggle('starred', starCheckbox.checked);
    
    updateCounts();
}

function updateCounts() {
    const snackSelectedCount = document.querySelectorAll('[data-category="snack"] .select-checkbox:checked').length;
    const juiceSelectedCount = document.querySelectorAll('[data-category="juice"] .select-checkbox:checked').length;
    const snackStarCount = document.querySelectorAll('[data-category="snack"] .star-checkbox:checked').length;
    const juiceStarCount = document.querySelectorAll('[data-category="juice"] .star-checkbox:checked').length;
    
    const snackSelectedEl = document.getElementById('snack-selected-count');
    const juiceSelectedEl = document.getElementById('juice-selected-count');
    const snackStarCountEl = document.getElementById('snack-star-count');
    const juiceStarCountEl = document.getElementById('juice-star-count');
    
    if (snackSelectedEl) snackSelectedEl.textContent = snackSelectedCount;
    if (juiceSelectedEl) juiceSelectedEl.textContent = juiceSelectedCount;
    if (snackStarCountEl) snackStarCountEl.textContent = snackStarCount;
    if (juiceStarCountEl) juiceStarCountEl.textContent = juiceStarCount;
    
    document.getElementById('total-selected').textContent = snackSelectedCount + juiceSelectedCount;
    document.getElementById('total-starred').textContent = snackStarCount + juiceStarCount;
}

function toggleSuggestionForm() {
    const form = document.getElementById('suggestion-form');
    const arrow = document.getElementById('suggestion-arrow');
    form.classList.toggle('hidden');
    arrow.classList.toggle('rotate-180');
}

function toggleItemNameField() {
    const suggestionType = document.getElementById('suggestion-type').value;
    const itemNameField = document.getElementById('item-name-field');
    const itemNameInput = document.getElementById('item-name');
    
    if (suggestionType === 'new_item') {
        itemNameField.classList.remove('hidden');
        itemNameInput.required = true;
    } else {
        itemNameField.classList.add('hidden');
        itemNameInput.required = false;
        itemNameInput.value = '';
    }
}

// Handle suggestion form submission
document.getElementById('suggestion-submit-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    e.stopPropagation();  // Prevent event bubbling
    
    const formData = {
        suggestion_type: document.getElementById('suggestion-type').value,
        item_name: document.getElementById('item-name').value,
        message: document.getElementById('suggestion-message').value,
        customer_name: document.getElementById('suggestion-name').value,
        customer_phone: document.getElementById('suggestion-phone').value,
    };
    
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    
    try {
        const response = await fetch('{% url "core:submit_suggestion" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show success message
            const messageDiv = document.getElementById('suggestion-message-div');
            messageDiv.className = 'p-4 bg-green-50 border border-green-200 rounded-lg text-green-800';
            messageDiv.textContent = 'Thank you! Your suggestion has been submitted.';
            messageDiv.classList.remove('hidden');
            
            // Reset form
            this.reset();
            toggleItemNameField();
            
            // Hide form after 3 seconds
            setTimeout(() => {
                toggleSuggestionForm();
                messageDiv.classList.add('hidden');
            }, 3000);
        } else {
            // Show error message
            const messageDiv = document.getElementById('suggestion-message-div');
            messageDiv.className = 'p-4 bg-red-50 border border-red-200 rounded-lg text-red-800';
            messageDiv.textContent = data.error || 'An error occurred. Please try again.';
            messageDiv.classList.remove('hidden');
        }
    } catch (error) {
        const messageDiv = document.getElementById('suggestion-message-div');
        messageDiv.className = 'p-4 bg-red-50 border border-red-200 rounded-lg text-red-800';
        messageDiv.textContent = 'An error occurred. Please try again.';
        messageDiv.classList.remove('hidden');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
});
</script>
{% endblock %}
