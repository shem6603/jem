{% extends 'admin/base.html' %}
{% load static %}

{% block title %}Customer Suggestions - J.E.M Admin{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-black text-gray-900 mb-2">üí° Customer Suggestions</h1>
    <p class="text-gray-600">Manage customer suggestions and feedback</p>
</div>

<!-- Filters -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
    <form method="get" class="flex flex-wrap gap-4 items-end">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
            <select name="type" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                <option value="">All Types</option>
                <option value="new_item" {% if filter_type == 'new_item' %}selected{% endif %}>New Item Requests</option>
                <option value="feedback" {% if filter_type == 'feedback' %}selected{% endif %}>General Feedback</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select name="reviewed" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                <option value="">All</option>
                <option value="pending" {% if filter_reviewed == 'pending' %}selected{% endif %}>Pending Review</option>
                <option value="reviewed" {% if filter_reviewed == 'reviewed' %}selected{% endif %}>Reviewed</option>
            </select>
        </div>
        <button type="submit" class="px-6 py-2 bg-orange-500 text-white font-semibold rounded-lg hover:bg-orange-600 transition">
            Filter
        </button>
        <a href="{% url 'admin_suggestions' %}" class="px-6 py-2 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 transition">
            Clear
        </a>
    </form>
</div>

<!-- Stats -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-600">Pending Review</p>
                <p class="text-3xl font-black text-orange-600">{{ pending_count }}</p>
            </div>
            <span class="text-4xl">‚è≥</span>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-600">New Item Requests</p>
                <p class="text-3xl font-black text-blue-600">{{ new_item_count }}</p>
            </div>
            <span class="text-4xl">üÜï</span>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-600">Feedback</p>
                <p class="text-3xl font-black text-green-600">{{ feedback_count }}</p>
            </div>
            <span class="text-4xl">üí¨</span>
        </div>
    </div>
</div>

<!-- Suggestions List -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    {% if suggestions %}
    <div class="divide-y divide-gray-200">
        {% for suggestion in suggestions %}
        <div class="p-6 {% if not suggestion.is_reviewed %}bg-yellow-50{% endif %}">
            <div class="flex items-start justify-between mb-4">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold {% if suggestion.suggestion_type == 'new_item' %}bg-blue-100 text-blue-800{% else %}bg-green-100 text-green-800{% endif %}">
                            {{ suggestion.get_suggestion_type_display }}
                        </span>
                        {% if not suggestion.is_reviewed %}
                        <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold">Pending</span>
                        {% else %}
                        <span class="px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-xs font-semibold">Reviewed</span>
                        {% endif %}
                        {% if suggestion.order %}
                        <a href="{% url 'admin_customer_order_detail' suggestion.order.id %}" class="text-sm text-orange-600 hover:text-orange-700 font-semibold">
                            Order: {{ suggestion.order.order_reference }}
                        </a>
                        {% endif %}
                    </div>
                    
                    {% if suggestion.item_name %}
                    <h3 class="text-lg font-bold text-gray-900 mb-2">
                        Item: {{ suggestion.item_name }}
                    </h3>
                    {% endif %}
                    
                    <p class="text-gray-700 mb-3 whitespace-pre-wrap">{{ suggestion.message }}</p>
                    
                    <div class="flex items-center gap-4 text-sm text-gray-600">
                        <span><strong>From:</strong> {{ suggestion.customer_name }}</span>
                        {% if suggestion.customer_phone %}
                        <span><strong>Phone:</strong> {{ suggestion.customer_phone }}</span>
                        {% endif %}
                        <span><strong>Date:</strong> {{ suggestion.created_at|date:"M d, Y g:i A" }}</span>
                    </div>
                    
                    {% if suggestion.admin_response %}
                    <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-sm font-semibold text-blue-900 mb-1">Admin Response:</p>
                        <p class="text-blue-800 whitespace-pre-wrap">{{ suggestion.admin_response }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="flex gap-3 mt-4">
                {% if not suggestion.is_reviewed %}
                <form method="post" class="inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="mark_reviewed">
                    <input type="hidden" name="suggestion_id" value="{{ suggestion.id }}">
                    <button type="submit" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition">
                        Mark as Reviewed
                    </button>
                </form>
                {% endif %}
                
                <button onclick="showResponseForm({{ suggestion.id }})" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition">
                    {% if suggestion.admin_response %}Update Response{% else %}Add Response{% endif %}
                </button>
                
                <form method="post" class="inline" onsubmit="return confirm('Are you sure you want to delete this suggestion?');">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="suggestion_id" value="{{ suggestion.id }}">
                    <button type="submit" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition">
                        Delete
                    </button>
                </form>
            </div>
            
            <!-- Response Form (Hidden by default) -->
            <div id="response-form-{{ suggestion.id }}" class="hidden mt-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_response">
                    <input type="hidden" name="suggestion_id" value="{{ suggestion.id }}">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Admin Response</label>
                    <textarea name="admin_response" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 mb-3">{{ suggestion.admin_response }}</textarea>
                    <div class="flex gap-3">
                        <button type="submit" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition">
                            Save Response
                        </button>
                        <button type="button" onclick="hideResponseForm({{ suggestion.id }})" class="px-4 py-2 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 transition">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="p-12 text-center">
        <span class="text-6xl mb-4 block">üí°</span>
        <p class="text-gray-600 text-lg">No suggestions found</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<script>
function showResponseForm(suggestionId) {
    document.getElementById('response-form-' + suggestionId).classList.remove('hidden');
}

function hideResponseForm(suggestionId) {
    document.getElementById('response-form-' + suggestionId).classList.add('hidden');
}
</script>
{% endblock %}
